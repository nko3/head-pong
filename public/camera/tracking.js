// Generated by CoffeeScript 1.4.0
(function() {
  var URL, canvas, hide_tracker, requestAnimationFrame, send_coordinates, smoother, track, video, _stop, _videoleft, _videotop;

  URL = window.URL || window.webkitURL;

  requestAnimationFrame = function(callback, element) {
    requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || function(callback, element) {
      var currTime, id, lastTime, timeToCall;
      currTime = new Date().getTime();
      timeToCall = Math.max(0, 16 - (currTime - lastTime));
      id = window.setTimeout(function() {
        return callback(currTime + timeToCall);
      }, timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };
    return requestAnimationFrame.call(window, callback, element);
  };

  _videoleft = $("#camvideo").offset().left;

  _videotop = $("#camvideo").offset().top;

  _stop = true;

  smoother = new Smoother(0.85, [0, 0, 0, 0, 0]);

  video = $("#camvideo");

  canvas = $("#pong");

  $("#trackbutton").on("click", function() {
    _stop = !_stop;
    requestAnimationFrame(track);
    if (_stop) {
      return hide_tracker();
    }
  });

  track = function() {
    if (!_stop) {
      requestAnimationFrame(track);
    }
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      return $("#camvideo").objectdetect("all", {
        scaleMin: 3,
        scaleFactor: 1.1,
        classifier: objectdetect.frontalface
      }, function(coords) {
        var canvas_width, height, left, top, width;
        if (coords[0]) {
          coords = smoother.smooth(coords[0]);
          left = ~~(coords[0] + coords[2] * 1.0 / 8 + $(video).offset().left);
          top = ~~(coords[1] + coords[3] * 0.8 / 8 + $(video).offset().top);
          width = ~~(coords[2] * 6 / 8);
          height = ~~(coords[3] * 6 / 8);
          canvas_width = $(canvas).width() + $(canvas).offset().left;
          send_coordinates(canvas_width - 30 - 1.7 * (left - $(video).offset().left), top);
          console.log("left: " + left + ", canvas: " + canvas_width + ", offset: " + ($(video).offset().left));
          return $("#tracker").css({
            "left": ($(video).width() - left - width) + "px",
            "top": top + "px",
            "width": width + "px",
            "height": height + "px",
            "display": "none"
          });
        } else {
          return hide_tracker();
        }
      });
    }
  };

  send_coordinates = function(x, y) {
    socket.emit('mouse_pos', x);
    return $("#coordinates").html("(" + x + ", " + y + ")");
  };

  hide_tracker = function() {
    return $("#tracker").css({
      "display": "none"
    });
  };

}).call(this);
